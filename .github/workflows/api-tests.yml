name: API Tests (Postman/Newman)
on:
  push:
    branches: [ "main" ]
    paths:
      - "Api.java"
      - ".github/workflows/api-tests.yml"
      - "postman/**"
  workflow_dispatch: {}

jobs:
  api-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Compile API (single file)
        run: |
          set -e
          if [ ! -f Api.java ]; then
            echo "::error file=Api.java::Api.java no existe en la raíz del repo"
            exit 1
          fi
          javac Api.java

      - name: Start API server (robust probe)
        run: |
          set -e
          nohup java --add-modules jdk.httpserver Api > server.log 2>&1 &
          echo $! > server.pid

          # Give JVM a moment
          sleep 1

          # Try for up to ~40s; don't fail on curl errors
          code=000
          for i in {1..40}; do
            code=$(curl -sS -o resp.txt -w "%{http_code}" http://127.0.0.1:8080/fib || echo "000")
            if [ "$code" = "400" ]; then
              echo "Server is up and /fib context is registered"
              rm -f resp.txt
              break
            fi
            echo "Probe $i: HTTP $code"
            sleep 1
          done

          # Always print some server log to help debugging
          echo "---- First 200 lines of server.log ----"
          sed -n '1,200p' server.log || true
          {
            echo "## server.log (first 200 lines)"
            sed -n '1,200p' server.log || true
          } >> $GITHUB_STEP_SUMMARY

          if [ "$code" != "400" ]; then
            echo "::error::Server did not expose /fib (expected 400). Last code: $code"
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Write Postman collection & env
        run: |
          mkdir -p postman
          cat > postman/collection.json <<'JSON'
          {
            "info": { "name": "ConstruccionYPruebas API Tests", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
            "item": [
              {
                "name": "Fibonacci OK (n=10 -> 55)",
                "request": { "method": "GET", "url": "{{baseUrl}}/fib", "query": [{ "key": "n", "value": "10" }] },
                "event": [{ "listen": "test", "script": { "exec": [
                  "pm.test('status 200', () => pm.response.to.have.status(200));",
                  "const json = pm.response.json();",
                  "pm.test('n=10, value=55', () => { pm.expect(json.n).to.eql(10); pm.expect(json.value).to.eql(55); });"
                ], "type": "text/javascript" }}]
              },
              {
                "name": "Fibonacci Bad Request (n<0)",
                "request": { "method": "GET", "url": "{{baseUrl}}/fib", "query": [{ "key": "n", "value": "-1" }] },
                "event": [{ "listen": "test", "script": { "exec": [
                  "pm.test('status 400', () => pm.response.to.have.status(400));",
                  "pm.test('error message present', () => pm.expect(pm.response.json().error).to.match(/n must be >= 0/i));"
                ], "type": "text/javascript" }}]
              },
              {
                "name": "Multiply OK (6*7 -> 42)",
                "request": { "method": "GET", "url": "{{baseUrl}}/multiply", "query": [
                  { "key": "a", "value": "6" }, { "key": "b", "value": "7" }
                ]},
                "event": [{ "listen": "test", "script": { "exec": [
                  "pm.test('status 200', () => pm.response.to.have.status(200));",
                  "pm.test('product 42', () => pm.expect(pm.response.json().product).to.eql(42));"
                ], "type": "text/javascript" }}]
              }
            ]
          }
          JSON
          cat > postman/env.json <<'JSON'
          { "name": "Localhost 8080", "values": [
              { "key": "baseUrl", "value": "http://localhost:8080", "enabled": true }
            ], "_postman_variable_scope": "environment" }
          JSON

      - name: Run Newman (robust + always report)
        if: always()
        run: |
          set +e
          echo "Node version:"; node -v
          echo "NPM version:"; npm -v
          echo "Newman in PATH?"; which newman || echo "not found"

          # Use npx to avoid PATH issues with global installs
          npx -y newman run postman/collection.json \
            -e postman/env.json \
            -r cli,htmlextra \
            --reporter-htmlextra-export postman/newman-report.html
          status=$?
          echo "Newman exit code: $status"

          # Guarantee an artifact even if Newman failed
          if [ ! -f postman/newman-report.html ]; then
            mkdir -p postman
            cat > postman/newman-report.html <<HTML
            <html><body>
              <h1>Newman did not produce a report (exit $status)</h1>
              <p>See the job logs above for details. Common causes:</p>
              <ul>
                <li>Collection or env JSON path wrong</li>
                <li>Server not reachable from runner</li>
                <li>Tests failed and reporter crashed</li>
              </ul>
            </body></html>
            HTML
          fi

          # Don’t fail the job here; artifact upload comes next
          exit 0

      - name: Attach logs to summary
        if: always()
        run: |
          echo "## Server log (last 200 lines)" >> $GITHUB_STEP_SUMMARY
          (tail -n 200 server.log || true) >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f postman/newman-report.html ]; then
            echo "Newman HTML report will be uploaded as artifact." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload artifacts (report + server log)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: |
            postman/newman-report.html
            server.log
